name: Deploy to GCP VM

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v2

    - name: Configure SSH Key
      run: |
        echo "$YOUR_SSH_PRIVATE_KEY" > ssh_key
        chmod 600 ssh_key
        eval "$(ssh-agent -s)"
        ssh-add ssh_key

    - name: Copy Code to GCP VM
      run: |
        scp -r -i ssh_key * YOUR_GCP_USERNAME@YOUR_GCP_INSTANCE_IP:/var/www/html/sslops
        ssh -i ssh_key YOUR_GCP_USERNAME@YOUR_GCP_INSTANCE_IP 'sudo systemctl restart nginx && sudo systemctl restart php7.4-fpm'
      env:
        YOUR_GCP_USERNAME: ${{ secrets.GCP_USERNAME }}
        YOUR_GCP_INSTANCE_IP: ${{ secrets.GCP_INSTANCE_IP }}
